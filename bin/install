#!/bin/bash

set -e

dir=$PWD
if [[ ! "$dir/bin/install" -ef "$0" ]]; then
  echo "Please run 'bin/install' from dotfiles root folder"
  exit 1
fi

#------------------------------------------------------------------------
#UTILS
#------------------------------------------------------------------------
COLOR_ESC='\033[0;'
COLOR_CYAN=$COLOR_ESC"36m"
COLOR_GREEN=$COLOR_ESC"32m"
COLOR_RED=$COLOR_ESC"31m"
COLOR_YELLOW=$COLOR_ESC"33m"
COLOR_RESET=$COLOR_ESC"0m"

fancy_echo() {
  local fmt="$1"; shift

  # shellcheck disable=SC2059
  printf "\n=> $fmt\n" "$@"
}

installing(){
  echo -n $1"... "
}

ok(){
  echo -e "${COLOR_GREEN}[ok]${COLOR_RESET}"
}

section_echo(){
  echo -e "\n${COLOR_CYAN}--------------- $1 ---------------${COLOR_RESET}\n"
}

# Sysmlink dotfiles to HOME directory and renaming existing file with .old suffix
symlink_or_skip(){
  local file=$1
  local link_path=$2
  local link_dir_path=$(dirname "${link_path}")
  local dotfile_path="${dir}/${file}"
  # If file exists and it's a symlink
  if [ -L "${link_path}" ]; then
    echo -e "${COLOR_YELLOW}Skipped. It already exists${COLOR_RESET}"
  else
    # If file exists
    if [ -f "${link_path}" ]; then
      mv "${link_path}" "${link_path}.old"
      echo -en "${COLOR_YELLOW}(Renaming ${file} to ${file}.old)${COLOR_RESET}\t"
    fi
    mkdir -p $link_dir_path
    ln -fs "${dotfile_path}" "${link_path}"
    echo -e "${COLOR_GREEN}Symlinked ${file} to ${link_path}${COLOR_RESET}"
  fi
}

#------------------------------------------------------------------------
# DOTFILES
#------------------------------------------------------------------------

section_echo "DOTFILES"

# Getting dotfiles list into an array
files=( $(find . -maxdepth 1 -name '.*' -type f | sed 's#^\./##') )

for file in ${files[@]}; do
  printf "${file}\t"
  symlink_or_skip $file "${HOME}/${file}"
done

#------------------------------------------------------------------------
# VIM
#------------------------------------------------------------------------

section_echo "VIM"
installing "Vim Monokai color theme"
symlink_or_skip .vim/colors/monokai.vim ${HOME}/.vim/colors/monokai.vim

installing "vim-plug"
curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim

installing "Vim plugins"
symlink_or_skip bundles.vim ${HOME}/.vim/bundles.vim
vim +PluginInstall +qall

#------------------------------------------------------------------------
# ZSH
#------------------------------------------------------------------------

section_echo "ZSH"
fancy_echo "Oh-My-Zsh plugins"

ZSH=~/.oh-my-zsh
zsh_plugins_path=$ZSH/custom/plugins

echo "Installing zsh-autosuggestions ..."
autosuggestions_path=$zsh_plugins_path/zsh-autosuggestions
if [ -d $autosuggestions_path ]; then
  echo "zsh-autosuggestions already installed."
else
  git clone git://github.com/zsh-users/zsh-autosuggestions $autosuggestions_path
fi

echo "Installing zsh-syntax-highlighting ..."
syntax_highlighting_path=$zsh_plugins_path/zsh-syntax-highlighting
if [ -d $syntax_highlighting_path ]; then
  echo "zsh-syntax-highlighting already installed."
else
  mkdir -p $zsh_plugins_path
  git clone git://github.com/zsh-users/zsh-syntax-highlighting.git $syntax_highlighting_path
fi
